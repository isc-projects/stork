<div class="flex flex-column">
    <div class="flex flex-wrap px-2 border-1 border-round surface-border">
        <div class="mr-5 my-2 flex align-items-center">
            <p-toggleswitch
                [ngModel]="daemon().monitored"
                (onChange)="changeMonitored()"
                inputId="monitored-switch"
                appAccessEntity="daemon-monitoring"
                appAccessType="update"
                styleClass="block"
            ></p-toggleswitch>
            <label for="monitored-switch" class="ml-2 my-auto">Monitoring</label>
        </div>
        <p-button
            *ngIf="isDhcpDaemon"
            routerLink="/dhcp/hosts"
            [queryParams]="{ daemonId: daemon().id }"
            label="Host Reservations"
            icon="fa fa-laptop"
            severity="secondary"
            class="mr-2 my-2"
            appAccessEntity="host-reservation"
        ></p-button>
        <p-button
            *ngIf="isDhcpDaemon"
            routerLink="/dhcp/subnets"
            [queryParams]="{ daemonId: daemon().id }"
            label="Subnets"
            icon="fa fa-project-diagram"
            class="mr-2 my-2"
            severity="secondary"
            appAccessEntity="subnet"
        ></p-button>
        <p-button
            *ngIf="isDhcpDaemon"
            routerLink="/dhcp/shared-networks"
            [queryParams]="{ daemonId: daemon().id }"
            label="Shared Networks"
            icon="fa fa-network-wired"
            class="mr-2 my-2"
            severity="secondary"
            appAccessEntity="shared-network"
        ></p-button>
        <p-button
            *ngIf="isDhcpDaemon"
            routerLink="/daemons/{{ daemon().id }}/global-config"
            label="Global Configuration"
            icon="fa-solid fa-globe"
            class="mr-2 my-2"
            severity="secondary"
            appAccessEntity="daemon-global-config"
        ></p-button>
        <p-button
            label="Raw configuration"
            icon="fa fa-file-alt"
            severity="secondary"
            class="mr-2 my-2"
            routerLink="/daemons/{{ daemon().id }}/config"
            appAccessEntity="daemon-config"
        ></p-button>
    </div>

    <div class="flex flex-column p-2">
        <!-- box with error message if there is communication issue or other problem with daemon -->
        <div *ngIf="daemonStatusErred()">
            <p-message severity="error" text="{{ daemonStatusErrorText() }}"></p-message>
        </div>

        <!-- warning about not-active and not-monitored -->
        <div *ngIf="!daemon().active">
            <p-message
                icon="pi pi-exclamation-triangle"
                *ngIf="!daemon().monitored && isNeverFetchedDaemon"
                severity="warn"
            >
                <div>
                    <p>
                        This daemon is currently not monitored by Stork. The daemon has not been active since being
                        added to the Stork server. This daemon appears in the list because its configuration was
                        detected in the Kea Control Agent's configuration file.
                    </p>
                    <p>
                        If the daemon is operational (e.g. it allocates leases), make sure it has the
                        <code>control-socket</code> entry in its configuration file.
                        <!-- The daemon version is unknown. -->
                        <a
                            *ngIf="daemon().name === 'dhcp4'"
                            href="https://kea.readthedocs.io/en/latest/arm/dhcp4-srv.html#management-api-for-the-dhcpv4-server"
                            target="_blank"
                            >See the Kea ARM</a
                        >
                        <a
                            *ngIf="daemon().name === 'dhcp6'"
                            href="https://kea.readthedocs.io/en/latest/arm/dhcp6-srv.html#management-api-for-the-dhcpv6-server"
                            target="_blank"
                            >See the Kea ARM</a
                        >
                        <a
                            *ngIf="daemon().name === 'd2'"
                            href="https://kea.readthedocs.io/en/latest/arm/ddns.html#management-api-for-the-d2-server"
                            target="_blank"
                            >See the Kea ARM</a
                        >
                        for details.
                    </p>
                </div>
            </p-message>

            <p-message
                *ngIf="!daemon().monitored && !isNeverFetchedDaemon"
                severity="warn"
                text="This daemon is currently not monitored by Stork.
                            The daemon was manually disabled."
            >
            </p-message>
            <p-message
                *ngIf="daemon().monitored"
                severity="error"
                text="There is a communication issue with the daemon."
            >
            </p-message>
        </div>

        <div class="grid">
            <!-- Overview -->
            <div class="col-12 md:col-6" [ngClass]="{ disabled: !daemon().active }">
                <h3 class="underlined">Overview</h3>
                <div class="grid">
                    <div class="col-12 lg:col-7">
                        <p-fieldset legend="Daemon Information">
                            <div class="grid grid-nogutter">
                                <div class="col-12 sm:col-3 pb-0 font-medium">Version</div>
                                <div class="col-12 sm:col-9">
                                    <app-version-status
                                        [daemon]="daemon()"
                                        [includeAnchor]="false"
                                    ></app-version-status>
                                </div>
                                <div class="col-12 sm:col-3 pb-0 font-medium">Version Ext</div>
                                <div class="col-12 sm:col-9 white-space-preline">
                                    {{ daemon().extendedVersion }}
                                </div>
                                <div class="col-12 sm:col-3 pb-0 font-medium">Uptime</div>
                                <div class="col-12 sm:col-9">{{ showDuration(daemon().uptime) }}</div>
                                <div class="col-12 sm:col-3 pb-0 font-medium">Last Reloaded At</div>
                                <div class="col-12 sm:col-9">
                                    {{ daemon().reloadedAt | localtime | placeholder: 'never' }}
                                </div>
                            </div>
                        </p-fieldset>
                    </div>
                    <div class="col-12 lg:col-5">
                        <p-fieldset id="hooks-fieldset" legend="Hooks">
                            <ol>
                                <li *ngFor="let hook of daemon().hooks" class="word-break-all">
                                    <div class="flex flex-wrap">
                                        <div
                                            class="flex flex-auto hook-name"
                                            pTooltip="Click to copy the hook path to the clipboard"
                                            (click)="copyHookPathToClipboard(hook)"
                                        >
                                            {{ basename(hook) }}
                                        </div>
                                        <div class="flex flex-none">
                                            <a
                                                *ngIf="docAnchorFromHookLibrary(basename(hook), daemon().version)"
                                                href="https://kea.readthedocs.io/en/{{
                                                    docAnchorFromHookLibrary(basename(hook), daemon().version)
                                                }}"
                                                target="_blank"
                                            >
                                                [doc]
                                            </a>
                                        </div>
                                    </div>
                                </li>
                            </ol>
                            <div *ngIf="daemon().hooks.length === 0" class="text-gray-400">No hooks</div>
                        </p-fieldset>
                        <p-fieldset id="hooks-fieldset" legend="Access points">
                            <app-access-points [daemon]="daemon()"></app-access-points>
                        </p-fieldset>
                    </div>
                </div>

                <!-- Database Configurations -->
                <div
                    id="data-storage-div"
                    *ngIf="
                        (daemon().files && daemon().files.length > 0) ||
                        (daemon().backends && daemon().backends.length > 0)
                    "
                    class="mt-4"
                >
                    <h3 class="underlined">Data Storage</h3>
                    <div class="grid">
                        <ng-container *ngIf="daemon().files">
                            <div class="col-12 lg:col-6">
                                <p-fieldset id="data-storage-files-fieldset" legend="Files">
                                    <table style="width: 100%">
                                        <tr *ngFor="let file of daemon().files">
                                            <td style="width: 8rem">{{ file.filetype }}:</td>
                                            <td>
                                                <i>{{ filenameFromFile(file) }}</i>
                                            </td>
                                        </tr>
                                    </table>
                                </p-fieldset>
                            </div>
                        </ng-container>
                        <div *ngIf="daemon().backends" class="col-12 lg:col-6">
                            <p-fieldset id="data-storage-backends-fieldset" legend="Database Backends">
                                <div *ngFor="let backend of daemon().backends">
                                    <i class="fa fa-database text-gray-400"></i>
                                    {{ databaseNameFromType(backend.backendType) }} ({{ backend.database }}&#64;{{
                                        backend.host
                                    }}) with:
                                    <ul class="word-break-all" style="list-style-type: disc">
                                        <li *ngFor="let dataType of backend.dataTypes">
                                            <i>{{ dataType }}</i>
                                        </li>
                                    </ul>
                                </div>
                            </p-fieldset>
                        </div>
                    </div>
                </div>

                <!-- Loggers -->
                <div class="mt-4">
                    <h3 class="underlined">Loggers</h3>
                    <p-table [value]="daemon().logTargets">
                        <ng-template #header>
                            <tr>
                                <th style="width: 10rem">Logger</th>
                                <th style="width: 7rem">Severity</th>
                                <th>Output Location</th>
                            </tr>
                        </ng-template>
                        <ng-template #body let-logTarget>
                            <tr>
                                <td>{{ logTarget.name }}</td>
                                <td align="center">{{ logTarget.severity }}</td>
                                <td>
                                    <i *ngIf="!logTargetViewable(logTarget.output)">{{ logTarget.output }}</i>
                                    <p-button
                                        *ngIf="logTargetViewable(logTarget.output)"
                                        routerLink="/logs/{{ logTarget.id }}"
                                        appAccessEntity="logs"
                                        [text]="true"
                                        ><i>{{ logTarget.output }}</i></p-button
                                    >
                                </td>
                            </tr>
                        </ng-template>
                        <ng-template #emptymessage let-columns>
                            <tr>
                                <td [attr.colspan]="3">No loggers found</td>
                            </tr>
                        </ng-template>
                    </p-table>
                </div>

                <div id="config-review-reports-div" class="mt-4" [ngClass]="{ disabled: !daemon().active }">
                    <h3 class="underlined">
                        Configuration Review Reports
                        <app-help-tip subject="daemon configuration review section">
                            <p>
                                The Stork server reviews the monitored servers' configurations, flags potential
                                configuration issues, and suggests changes to these configurations to improve Stork's
                                monitoring capabilities. The review is performed using different checkers built into the
                                Stork server. Each checker is responsible for examining a different part or aspect of
                                the configuration. Each checker has a unique name, which is shown in the blue badge
                                before the text of each issue in the list below.
                            </p>
                            <p>
                                Each checker can be disabled if its review report is not desired in a particular
                                deployment.
                            </p>
                            <p>
                                By default, only reports that discover an issue are visible. Use the toggle button to
                                display reports from all executed checkers for a given daemon.
                            </p>
                        </app-help-tip>
                    </h3>
                    <app-config-review-panel [daemonId]="daemon().id"></app-config-review-panel>
                </div>

                <!-- High Availability -->
                <div *ngIf="isDhcpDaemon" class="mt-4" [ngClass]="{ disabled: !daemon().active }">
                    <app-ha-status [daemonId]="daemon().id" [daemonName]="daemon().name"></app-ha-status>
                </div>
            </div>
            <div class="col-12 md:col-6">
                <h3 class="underlined">Events</h3>
                <app-events-panel [filter]="{ daemon: daemon().id }"></app-events-panel>
            </div>
        </div>
    </div>
</div>
