<p-confirmDialog styleClass="w-4" rejectButtonStyleClass="p-button-text"></p-confirmDialog>
<app-breadcrumbs [items]="breadcrumbs">
    <div page-help>
        <p>This page displays a list of apps.</p>
    </div>
</app-breadcrumbs>

<app-tab-view routePath="/apps/" [entitiesCollection]="apps" [entityProvider]="appProvider">
    <ng-template #firstTab let-onRefreshApp="updateTabEntityFn">
        <div class="flex flex-wrap gap-2 justify-content-end mb-3">
            <span class="p-input-icon-left flex min-w-0">
                <i class="pi pi-search"></i>
                <input
                    type="text"
                    id="filter-apps-text-field"
                    pInputText
                    placeholder="Search apps"
                    (input)="inputFilterText(appsTable, $event.target?.value)"
                    (keyup.enter)="inputFilterText(appsTable, $event.target?.value, true)"
                    [value]="appsTable.filters?.text?.value || appsTable.filters?.[0]?.text?.value"
                />
            </span>
            <button
                pButton
                label="Clear"
                class="ml-2 flex-none"
                icon="pi pi-filter-slash"
                (click)="clearFilters(appsTable)"
            ></button>
            <div class="flex flex-auto gap-2 flex-wrap justify-content-end">
                <div class="flex-auto"></div>
                <p-button
                    id="apps-refresh-button"
                    label="Refresh"
                    icon="pi pi-refresh"
                    (click)="refreshAppsList()"
                    class="flex-none"
                ></p-button>
                <p-button
                    id="sync-kea-configs-button"
                    label="Resynchronize Kea Configs"
                    icon="pi pi-file-import"
                    class="flex-none"
                    styleClass="p-button-warning"
                    (click)="onSyncKeaConfigs()"
                    appAccessEntity="kea-config-hashes"
                    appAccessType="delete"
                ></p-button>
            </div>
        </div>
        <p-menu #appMenu [popup]="true" [model]="appMenuItems"></p-menu>
        <p-table
            #appsTable
            [value]="apps"
            [paginator]="true"
            [rows]="10"
            [lazy]="true"
            [loading]="dataLoading"
            (onLazyLoad)="loadApps($event)"
            [totalRecords]="totalApps"
            [rowsPerPageOptions]="[10, 30, 100]"
            [showCurrentPageReport]="true"
            currentPageReportTemplate="{currentPage} of {totalPages} pages"
            stateStorage="session"
            stateKey="apps-table-session"
            styleClass="p-datatable-striped"
        >
            <ng-template #header>
                <tr>
                    <th style="width: 14em">Name</th>
                    <th>Version</th>
                    <th>Status</th>
                    <th>Machine Address</th>
                    <th>Machine Hostname</th>
                    <th style="width: 4rem">Action</th>
                </tr>
            </ng-template>
            <ng-template #body let-a>
                <tr>
                    <td>
                        <a routerLink="/apps/{{ a.id }}">{{ a.name }}</a>
                    </td>
                    <td>
                        <a routerLink="/apps/{{ a.id }}">{{ a.version }}</a>
                        <app-version-status [app]="a.type" [version]="a.version"></app-version-status>
                    </td>
                    <td>
                        <app-app-daemons-status [app]="a"></app-app-daemons-status>
                    </td>
                    <td>
                        <a routerLink="/machines/{{ a.machine.id }}">{{ a.machine.address }}</a>
                    </td>
                    <td>
                        <a routerLink="/machines/{{ a.machine.id }}">{{ a.machine.hostname }}</a>
                    </td>
                    <td>
                        <button
                            id="{{ 'menu-of-' + a.machine.id }}"
                            type="button"
                            pButton
                            icon="pi pi-bars"
                            (click)="showAppMenu($event, onRefreshApp, a.id)"
                        ></button>
                    </td>
                </tr>
            </ng-template>
            <ng-template #paginatorright let-state>
                Total: {{ state.totalRecords > 0 ? state.totalRecords : '0' }}
                {{ state.totalRecords === 1 ? 'app' : 'apps' }}
            </ng-template>
            <ng-template #emptymessage>
                <tr>
                    <td colspan="6">
                        No apps were found.
                        <span *ngIf="appsTable.hasFilter()">
                            Clear filtering and try again.
                            <button
                                pButton
                                label="Clear"
                                class="p-button-outlined"
                                icon="pi pi-filter-slash"
                                (click)="clearFilters(appsTable)"
                            ></button>
                        </span>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </ng-template>
    <ng-template #entityTab let-app let-onRenameApp="updateTabTitleFn" let-onRefreshApp="updateTabEntityFn">
        <app-app-tab
            *ngIf="app.type === 'bind9' || app.type === 'pdns'"
            [appTab]="{ app: app }"
            (refreshApp)="onRefreshApp($event)"
            (renameApp)="onRenameApp(app.id, $event)"
        ></app-app-tab>
        <app-kea-app-tab
            *ngIf="app.type === 'kea'"
            [appTab]="{ app: app }"
            (refreshApp)="onRefreshApp($event)"
            (renameApp)="onRenameApp(app.id, $event)"
        ></app-kea-app-tab>
    </ng-template>
</app-tab-view>
