<div appAccessEntity="migrations-hosts" appAccessType="create" [appHideIfNoAccess]="true">
    <p-confirmDialog key="migrationToDatabaseDialog">
        <ng-template #message>
            <div class="block ml-3 max-w-40rem message">
                <p>Are you sure you want to migrate host reservations to the database?</p>
                <p>
                    You are about to migrate host reservations defined in a configuration file to a database ("host
                    backend"). After the migration, hosts will be deleted from your configuration file and will be kept
                    in the database only. All the hosts selected by the current filter (including those on other pages,
                    if there are more hosts than fit on a single page) will be considered. Those that can't be migrated
                    (e.g. because they're already in a database or are in a conflicted state) will be skipped. The
                    migration is not instantaneous and will take some time.
                </p>
                <p>
                    The number of hosts to be migrated is <strong>{{ totalRecords }}</strong
                    >. They are selected by the following filter:
                </p>
                <div class="w-full">
                    <div *ngFor="let entry of migrationFilterEntries" class="flex flex-row gap-2">
                        <span class="font-bold text-right flex-1">{{ entry[0] }}</span>
                        <span class="flex-1">{{ entry[1] }}</span>
                    </div>
                </div>

                <p>
                    This operation will lock the related daemons for modifications. During the migration, the Stork
                    server will not synchronize the Kea data (i.e., the Kea configuration, subnets, shared networks,
                    host reservations).
                </p>
                <p>The migration can be canceled at any time.</p>
            </div>
        </ng-template>
    </p-confirmDialog>
</div>
<p-table
    id="hosts-table"
    #hostsTable
    [value]="dataCollection"
    [paginator]="true"
    [rows]="rows"
    [lazy]="true"
    [loading]="dataLoading"
    (onLazyLoad)="loadData($event)"
    [lazyLoadOnInit]="false"
    [totalRecords]="totalRecords"
    [rowsPerPageOptions]="[10, 30, 100]"
    [showCurrentPageReport]="true"
    currentPageReportTemplate="{currentPage} of {totalPages} pages"
    [stripedRows]="true"
    stateStorage="local"
    (rowsChange)="storeTableRowsPerPage($event)"
    class="full-w-table"
>
    <ng-template #caption>
        <app-table-caption [tableElement]="hostsTable" tableKey="hosts-table" [wideHelpTip]="true">
            <ng-template #helptip>
                <p>
                    Hosts in the table below can be filtered by entering text in the search box; the table shows all
                    hosts matching the filter text. The currently supported fields for filtering are:
                </p>
                <ul>
                    <li>Identifier</li>
                    <li>Identifier Type</li>
                    <li>Address</li>
                    <li>Hostname</li>
                </ul>
                <p>
                    Hosts can be filtered by their identifier value, e.g. <b>00:01:02:03:04:05</b>; a part of the
                    identifier (e.g. the initial three bytes of a MAC address that denotes OUI, a unique identifier of
                    the vendor, effectively showing all devices produced by the same vendor); or identifier type (e.g.
                    <b>hw-address</b> to show all reservations made by a MAC address).
                </p>
                <p>
                    Hosts can be also filtered by a full or partial IP address. For example, all reservations in a
                    192.0.2.0/24 subnet can found by entering
                    <b>192.0.2</b> as the filter text.
                </p>
                <p>
                    The <b>Global</b> checkbox allows users to see global hosts (i.e. the hosts valid for all subnets),
                    hosts associated with specific subnets, or all hosts. When the box is clicked once, the results show
                    all DHCP identifiers set at the global level; when clicked a second time, it excludes the global
                    hosts and shows only hosts that are associated with defined subnets.
                </p>
                <p>
                    Hosts with inconsistent DHCP configurations can be filtered using the
                    <b>Conflict</b> checkbox. When the box is clicked once, the filter returns all hosts whose
                    configurations contain conflicts between the configuration file and host database. When clicked a
                    second time, the results exclude any hosts with configuration conflicts.
                </p>
                <p>
                    In addition, hosts can be filtered by an explicitly selected field using text input filters. The
                    currently supported fields for explicit filtering are:
                </p>
                <ul>
                    <li>Machine ID - the ID of the machine used by Stork.</li>
                    <li>Daemon ID - the ID of the daemon used by Stork.</li>
                    <li>Subnet ID - the subnet ID used by Stork.</li>
                    <li>Kea Subnet ID - the subnet ID assigned to the subnet in the Kea configuration.</li>
                </ul>
                <p>
                    Hosts can be filtered by multiple fields. Currently, all provided filtering conditions are joined
                    using a logical AND.
                </p>
            </ng-template>
            <ng-template #filters>
                <p-columnFilter field="machineId" matchMode="equals" [showMenu]="false" [showClearButton]="false">
                    <ng-template pTemplate="filter" let-value let-filterMetadata="filterConstraint">
                        <div class="flex align-items-center">
                            <p-floatlabel variant="on">
                                <p-inputNumber
                                    inputId="machine-id"
                                    mode="decimal"
                                    [useGrouping]="false"
                                    min="1"
                                    (onInput)="filterTable($event.value === 0 ? 1 : $event.value, filterMetadata)"
                                    [ngModel]="value"
                                    class="max-w-8rem"
                                ></p-inputNumber>
                                <label for="machine-id">Machine ID</label>
                            </p-floatlabel>
                            <p-button
                                icon="pi pi-filter-slash"
                                [rounded]="true"
                                [text]="true"
                                severity="secondary"
                                [styleClass]="value ? '' : 'hidden-space'"
                                (onClick)="clearFilter(filterMetadata)"
                            />
                        </div>
                    </ng-template>
                </p-columnFilter>
                <p-columnFilter field="daemonId" matchMode="equals" [showMenu]="false" [showClearButton]="false">
                    <ng-template pTemplate="filter" let-value let-filterMetadata="filterConstraint">
                        <div class="flex align-items-center">
                            <p-floatlabel variant="on">
                                <p-inputNumber
                                    inputId="daemon-id"
                                    mode="decimal"
                                    [useGrouping]="false"
                                    min="1"
                                    (onInput)="filterTable($event.value === 0 ? 1 : $event.value, filterMetadata)"
                                    [ngModel]="value"
                                    class="max-w-8rem"
                                ></p-inputNumber>
                                <label for="daemon-id">Daemon ID</label>
                            </p-floatlabel>
                            <p-button
                                icon="pi pi-filter-slash"
                                [rounded]="true"
                                [text]="true"
                                severity="secondary"
                                [styleClass]="value ? '' : 'hidden-space'"
                                (onClick)="clearFilter(filterMetadata)"
                            />
                        </div>
                    </ng-template>
                </p-columnFilter>
                <p-columnFilter field="subnetId" matchMode="equals" [showMenu]="false" [showClearButton]="false">
                    <ng-template pTemplate="filter" let-value let-filterMetadata="filterConstraint">
                        <div class="flex align-items-center">
                            <p-floatlabel variant="on">
                                <p-inputNumber
                                    inputId="subnet-id"
                                    mode="decimal"
                                    [useGrouping]="false"
                                    min="1"
                                    (onInput)="filterTable($event.value === 0 ? 1 : $event.value, filterMetadata)"
                                    [ngModel]="value"
                                    class="max-w-8rem"
                                ></p-inputNumber>
                                <label for="subnet-id">Subnet ID</label>
                            </p-floatlabel>
                            <p-button
                                icon="pi pi-filter-slash"
                                [rounded]="true"
                                [text]="true"
                                severity="secondary"
                                [styleClass]="value ? '' : 'hidden-space'"
                                (onClick)="clearFilter(filterMetadata)"
                            />
                        </div>
                    </ng-template>
                </p-columnFilter>
                <p-columnFilter field="keaSubnetId" matchMode="equals" [showMenu]="false" [showClearButton]="false">
                    <ng-template pTemplate="filter" let-value let-filterMetadata="filterConstraint">
                        <div class="flex align-items-center">
                            <p-floatlabel variant="on">
                                <p-inputNumber
                                    inputId="kea-subnet-id"
                                    mode="decimal"
                                    [useGrouping]="false"
                                    min="1"
                                    (onInput)="filterTable($event.value === 0 ? 1 : $event.value, filterMetadata)"
                                    [ngModel]="value"
                                    class="max-w-8rem"
                                ></p-inputNumber>
                                <label for="kea-subnet-id">Kea Subnet ID</label>
                            </p-floatlabel>
                            <p-button
                                icon="pi pi-filter-slash"
                                [rounded]="true"
                                [text]="true"
                                severity="secondary"
                                [styleClass]="value ? '' : 'hidden-space'"
                                (onClick)="clearFilter(filterMetadata)"
                            />
                        </div>
                    </ng-template>
                </p-columnFilter>
                <p-columnFilter
                    type="boolean"
                    field="isGlobal"
                    matchMode="equals"
                    [showMenu]="false"
                    [showClearButton]="false"
                >
                    <ng-template pTemplate="filter" let-value let-filterMetadata="filterConstraint">
                        <div class="flex align-items-center">
                            <app-tri-state-checkbox
                                label="Global"
                                inputID="conflict-filter"
                                [value]="value"
                                (valueChange)="filterTable($event, filterMetadata, false)"
                            />
                            <p-button
                                icon="pi pi-filter-slash"
                                [rounded]="true"
                                [text]="true"
                                severity="secondary"
                                [styleClass]="value === null ? 'hidden-space' : ''"
                                (onClick)="clearFilter(filterMetadata)"
                            />
                        </div>
                    </ng-template>
                </p-columnFilter>
                <p-columnFilter
                    type="boolean"
                    field="conflict"
                    matchMode="equals"
                    [showMenu]="false"
                    [showClearButton]="false"
                >
                    <ng-template pTemplate="filter" let-value let-filterMetadata="filterConstraint">
                        <div class="flex align-items-center">
                            <app-tri-state-checkbox
                                label="Conflict"
                                inputID="conflict-filter"
                                [value]="value"
                                (valueChange)="filterTable($event, filterMetadata, false)"
                            />
                            <p-button
                                icon="pi pi-filter-slash"
                                [rounded]="true"
                                [text]="true"
                                severity="secondary"
                                [styleClass]="value === null ? 'hidden-space' : ''"
                                (onClick)="clearFilter(filterMetadata)"
                            />
                        </div>
                    </ng-template>
                </p-columnFilter>
                <p-columnFilter field="text" matchMode="contains" [showMenu]="false" [showClearButton]="false">
                    <ng-template pTemplate="filter" let-value let-filterMetadata="filterConstraint">
                        <div class="flex">
                            <p-iconfield iconPosition="left">
                                <p-inputicon>
                                    <i class="pi pi-search"></i>
                                </p-inputicon>
                                <input
                                    class="max-w-13rem sm:max-w-20rem"
                                    pInputText
                                    type="text"
                                    (input)="filterTable($event.target.value, filterMetadata)"
                                    [ngModel]="value"
                                    placeholder="Search IP or identifier"
                                />
                            </p-iconfield>
                            <p-button
                                icon="pi pi-filter-slash"
                                [rounded]="true"
                                [text]="true"
                                severity="secondary"
                                [styleClass]="value ? '' : 'hidden-space'"
                                (onClick)="clearFilter(filterMetadata)"
                            />
                        </div>
                    </ng-template>
                </p-columnFilter>
            </ng-template>
            <ng-template #buttons>
                <p-button
                    label="Migrate to Database"
                    icon="pi pi-database"
                    [disabled]="!totalRecords || isFilteredByConflict() || !canStartMigration()"
                    (onClick)="migrateToDatabaseAsk()"
                    appAccessEntity="migrations-hosts"
                    appAccessType="create"
                    (appHasAccess)="canStartMigration.set($event)"
                ></p-button>
                <p-button
                    label="New Host"
                    icon="pi pi-plus"
                    routerLink="/dhcp/hosts/new"
                    appAccessEntity="host-reservation"
                    appAccessType="create"
                    (appHasAccess)="canCreateHosts.set($event)"
                ></p-button>
                <p-button
                    label="Refresh List"
                    icon="pi pi-refresh"
                    (onClick)="loadData(hostsTable.createLazyLoadMetadata())"
                ></p-button>
            </ng-template>
            <ng-template #splitbutton>
                <p-splitbutton
                    label="Refresh List"
                    icon="pi pi-refresh"
                    (onClick)="loadData(hostsTable.createLazyLoadMetadata())"
                    [model]="toolbarButtons"
                    size="small"
                />
            </ng-template>
        </app-table-caption>
    </ng-template>
    <ng-template #header>
        <tr>
            <th style="width: 28%" [pSortableColumn]="HostSortField.Identifier">
                <div class="flex gap-1 white-space-nowrap">
                    DHCP Identifiers<p-sortIcon [field]="HostSortField.Identifier" />
                </div>
            </th>
            <th style="width: 18%" [pSortableColumn]="HostSortField.ReservationAddress">
                <div class="flex gap-1 white-space-nowrap">
                    IP Addresses<p-sortIcon [field]="HostSortField.ReservationAddress" />
                </div>
            </th>
            <th style="width: 14%" [pSortableColumn]="HostSortField.ReservationIpv6Prefix">
                <div class="flex gap-1 white-space-nowrap">
                    IPv6 Prefixes<p-sortIcon [field]="HostSortField.ReservationIpv6Prefix" />
                </div>
            </th>
            <th style="width: 14%" [pSortableColumn]="HostSortField.Hostname">
                <div class="flex gap-1">Hostname<p-sortIcon [field]="HostSortField.Hostname" /></div>
            </th>
            <th style="width: 12%" [pSortableColumn]="HostSortField.Subnet">
                <div class="flex gap-1">Global/Subnet<p-sortIcon [field]="HostSortField.Subnet" /></div>
            </th>
            <th style="width: 14%">Daemon</th>
        </tr>
    </ng-template>
    <ng-template #emptymessage>
        <tr>
            <td colspan="6">
                No hosts found.
                <span *ngIf="tableHasFilter(hostsTable)">
                    Clear filtering and try again.
                    <p-button
                        label="Clear"
                        [outlined]="true"
                        icon="pi pi-filter-slash"
                        (click)="clearTableFiltering()"
                    ></p-button>
                </span>
            </td>
        </tr>
    </ng-template>
    <ng-template #body let-h>
        <tr id="host-row-{{ h.id }}">
            <td>
                <app-identifier
                    *ngFor="let i of h.hostIdentifiers"
                    [label]="i.idType"
                    [hexValue]="i.idHexValue"
                    [defaultHexFormat]="['hw-address', 'duid', 'client-id'].includes(i.idType)"
                    link="/dhcp/hosts/{{ h.id }}"
                >
                </app-identifier>
            </td>
            <td>
                <app-entity-link
                    *ngFor="let r of h.addressReservations"
                    entity="host"
                    [showEntityName]="false"
                    [attrs]="{ id: h.id, label: r.address }"
                ></app-entity-link>
            </td>
            <td>
                <app-entity-link
                    *ngFor="let r of h.prefixReservations"
                    entity="host"
                    [showEntityName]="false"
                    [attrs]="{ id: h.id, label: r.address }"
                ></app-entity-link>
            </td>
            <td>
                {{ h.hostname }}
            </td>
            <td *ngIf="h.subnetId; else globalSubnetBlock">
                <app-entity-link
                    entity="subnet"
                    [showEntityName]="false"
                    [attrs]="{ id: h.subnetId, subnet: h.subnetPrefix }"
                ></app-entity-link>
            </td>
            <ng-template #globalSubnetBlock>
                <td>global</td>
            </ng-template>
            <td>
                <div *ngFor="let lhs of localHostsGroupedByDaemon[h.id]" class="flex align-items-baseline">
                    <!-- Hyperlink to the daemon details -->
                    <app-entity-link entity="daemon" [showEntityName]="false" [attrs]="lhs[0]"></app-entity-link>
                    <!-- Data source labels -->
                    <app-host-data-source-label
                        *ngFor="let lh of lhs"
                        class="ml-2 mt-1"
                        [dataSource]="lh.dataSource"
                    ></app-host-data-source-label>
                    <!-- Conflict label -->
                    <p-tag
                        *ngIf="getLocalHostsState(lhs) === 'conflict'"
                        class="ml-2 mt-1"
                        value="conflict"
                        severity="danger"
                        pTooltip="The host's configurations are different in the configuration file and the host database."
                    ></p-tag>
                    <!-- Duplicate label -->
                    <p-tag
                        *ngIf="getLocalHostsState(lhs) === 'duplicate'"
                        class="ml-2 mt-1"
                        value="duplicate"
                        severity="warn"
                        pTooltip="The host is duplicated in the configuration file and host database."
                    ></p-tag>
                </div>
            </td>
        </tr>
    </ng-template>
    <ng-template #paginatorright let-paginatorState>
        Total: {{ paginatorState.totalRecords | pluralize: 'host' }}
    </ng-template>
    <ng-template #emptymessage>
        <tr>
            <td colspan="6">
                No hosts found.
                <span *ngIf="tableHasFilter(hostsTable)">
                    Clear filtering and try again.
                    <p-button
                        label="Clear"
                        [outlined]="true"
                        icon="pi pi-filter-slash"
                        (click)="clearTableFiltering()"
                    ></p-button>
                </span>
            </td>
        </tr>
    </ng-template>
</p-table>
